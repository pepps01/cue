name: Deploy Laravel App

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST_NAME }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.CUE_SSH_KEY }}
          script: |
            # 1. Define the correct root directory
            APP_DIR="/home/ubuntu/cue"

            # 2. Check and enter the directory
            if [ -d "$APP_DIR" ]; then
              cd "$APP_DIR"
              git pull origin main
            else
              # Initial clone if the folder is missing
              git clone https://github.com/pepps01/cue.git "$APP_DIR"
              cd "$APP_DIR"
            fi

            # 3. USE THE CORRECT FILENAME
            # Your screenshot shows 'docker-compose.yaml'
            if [ -f "docker-compose.yaml" ]; then
              docker compose up -d --build

              # 4. RUN LARAVEL COMMANDS IN THE 'main' SERVICE
              # Your docker-compose.yaml names the service 'main'
              docker compose exec -T main php artisan migrate --force
              docker compose exec -T main php artisan config:cache
              docker compose exec -T main php artisan route:cache
            else
              echo "CRITICAL ERROR: docker-compose.yaml not found in $(pwd)"
              ls -la # Diagnostic: List files to help debug if it fails again
              exit 1
            fi
